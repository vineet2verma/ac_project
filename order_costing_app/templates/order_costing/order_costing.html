{% extends "base.html" %}
{% block title %}Order Costing{% endblock %}

{% block content %}

<style>
    body {
        font-size: 14px;
        background: #fff;
    }

    .erp-title {
        font-size: 18px;
        font-weight: 700;
    }

    .erp-subtitle {
        font-size: 12px;
        font-weight: 500;
        color: #666;
        display: block;
        margin-top: 4px;
    }

    table th {
        background: #f2f4f7;
        font-weight: 600;
        vertical-align: middle;
    }

    table td {
        vertical-align: middle;
    }

    .section-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-bottom: 16px;
    }

    .section-header {
        background: #f8f9fa;
        font-weight: 700;
        padding: 8px 12px;
        border-bottom: 1px solid #dee2e6;
    }

    /* ---------- PRINT ---------- */
    @media print {

        body {
            font-size: 12px;
        }
        .erp-subtitle {
            display: block !important;
        }

        .print-row {
            display: flex !important;
            flex-wrap: nowrap !important;
        }

        .print-image {
            width: 35% !important;
            max-width: 35% !important;
            padding-right: 10px;
        }

        .print-table {
            width: 65% !important;
            max-width: 65% !important;
        }

        img {
            max-height: 320px;
            page-break-inside: avoid;
        }

        table, tr, td, th {
            page-break-inside: avoid;
        }

        .no-print, button {
            display: none !important;
        }
    }

    @page {
        size: A4;
        margin: 15mm;
    }
</style>

<div class="container mt-3">

    <!-- TOP BAR -->
    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <button class="btn btn-outline-secondary btn-sm" onclick="history.back()">
            ‚Üê Back
        </button>

        <button class="btn btn-primary btn-sm" onclick="window.print()">
            üñ® Print
        </button>
    </div>

    <!-- HEADER -->
    <div class="mb-3">
        <div class="erp-title">Order Costing</div>
        <div class="erp-subtitle">
            Created: {{ order.created_at|date:"d M Y" }}  &nbsp; |
            Completed: {{ order.dispatched_at|date:"d M Y"|default:"‚Äî" }} &nbsp; |
            No of Days: &nbsp;
            <span class="{% if total_days and total_days > 10 %}text-danger{% endif %}">
                {{ total_days|default:"‚Äî" }}
            </span>
        </div>
        <hr>
    </div>

    <!-- IMAGE + DESIGN DETAILS -->
    <div class="row print-row mb-4">

        <!-- IMAGE -->
        <div class="col-md-4 print-image text-center">
            {% if order.image %}
                <img src="{{ order.image }}"
                     class="img-fluid border rounded shadow-sm"
                     alt="Design Image">
            {% else %}
                <div class="text-muted">No Image</div>
            {% endif %}
        </div>

        <!-- DESIGN DETAILS -->
        <div class="col-md-8 print-table">
            <table class="table table-bordered table-sm">
                <tbody>
                    <tr>
                        <th style="width:35%">Design Title</th>
                        <td>{{ order.title }}</td>
                    </tr>
                    <tr>
                        <th>Stone</th>
                        <td>{{ order.stone }}</td>
                    </tr>
                    <tr>
                        <th>Color</th>
                        <td>{{ order.color|title }}</td>
                    </tr>
                    <tr>
                        <th>Coverage Area</th>
                        <td>{{ order.coverage_area }}</td>
                    </tr>
                    <tr>
                        <th>Party Name</th>
                        <td>{{ order.party_name|title }}</td>
                    </tr>
                    <tr>
                        <th>Sales Person</th>
                        <td>{{ order.sales_person|title }}</td>
                    </tr>
                    <tr>
                        <th>Packing</th>
                        <td>{{ order.packing_instruction|default:"‚Äî" }}</td>
                    </tr>
                    <tr>
                        <th>Remarks</th>
                        <td>{{ order.remarks|default:"‚Äî" }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- MATERIAL / INVENTORY -->
    <div class="section-card">
        <div class="section-header">Material / Inventory Consumption</div>

        <table class="table table-bordered table-sm mb-0">
            <thead>
                <tr>
                    <th>Item</th>
                    <th class="text-end">Qty</th>
                    <th class="text-end">Rate</th>
                    <th class="text-end">Amount</th>
                </tr>
            </thead>
            <tbody>

            {% if material_rows %}
                {% for item in material_rows %}
                <tr>
                    <td>{{ item.item_name }}</td>
                    <td class="text-end">{{ item.qty }}</td>
                    <td class="text-end">‚Çπ {{ item.unit_cost }}</td>
                    <td class="text-end">‚Çπ {{ item.total_cost }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        No material consumed
                    </td>
                </tr>
            {% endif %}

                <tr class="fw-bold">
                    <td colspan="3" class="text-end">Material Total</td>
                    <td class="text-end">‚Çπ {{ material_cost|default:"0" }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- PRODUCTION COST -->
    <div class="section-card">
        <div class="section-header">Production Cost Summary</div>

        <table class="table table-bordered table-sm mb-0">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Info</th>
                    <th class="text-end">Cost</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Material Cost</td>
                    <td></td>
                    <td class="text-end">‚Çπ {{ material_cost|default:"0" }}</td>
                </tr>

                <tr>
                    <td>Machine Cost</td>
                    <td>{{ machine_hours|default:"0" }} hrs √ó ‚Çπ {{ machine_rate|default:"0" }}</td>
                    <td class="text-end">‚Çπ {{ machine_cost|default:"0" }}</td>
                </tr>

                <tr>
                    <td>Design Cost</td>
                    <td>Rate ‚Çπ {{ rate_config.design.default_rate_per_hour|default:"0" }} / hr</td>
                    <td class="text-end">‚Çπ {{ design_cost|default:"0" }}</td>
                </tr>

                <tr>
                    <td>QC Cost</td>
                    <td>Flat</td>
                    <td class="text-end">‚Çπ {{ qc_cost|default:"0" }}</td>
                </tr>

                <tr>
                    <td>Dispatch Cost</td>
                    <td>Freight + Loading</td>
                    <td class="text-end">‚Çπ {{ dispatch_cost|default:"0" }}</td>
                </tr>

                <tr class="fw-bold">
                    <td colspan="2" class="text-end">Total Order Cost</td>
                    <td class="text-end">‚Çπ {{ total_cost|default:"0" }}</td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

{% endblock %}
