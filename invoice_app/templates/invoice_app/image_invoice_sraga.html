{% extends "base.html" %}
{% load static %}
{% block title %}Create Quotation{% endblock %}

{% block content %}

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <style>
        input, select, textarea {
            font-size: 12px !important;
        }
        .image-cell img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #999;
        }
        @media print {
            .no-print { display:none !important; }
        }
        .modal input, .modal select {
            pointer-events: auto !important;
            border: 1px solid #ced4da !important;
        }
    </style>

    <div class="container-fluid mt-3 quotation-box">

        <!-- HEADER -->
        <div class="text-center mb-3">
            <h4 class="fw-bold">SRAGA INDIA</h4>
            <div>KH.No. 12/8, 12/9, Village Mandoli, East Delhi</div>
            <div>GSTIN: 07AEMFS7374F1ZJ</div>
            <h5 class="text-decoration-underline mt-2">QUOTATION</h5>
        </div>

        <!-- CUSTOMER DETAILS -->
        <table class="table table-bordered table-sm">
            <tr>
                <th>Company</th>
                <td id="v_company">â€”</td>
                <th>Date</th>
                <td>{% now "d-m-Y" %}</td>
            </tr>

            <tr>
                <th>Client</th>
                <td id="v_name">â€”</td>
                <th>GSTIN</th>
                <td id="v_gst">â€”</td>
            </tr>

            <tr>
                <th>Sales Person</th>
                <td id="v_sales">â€”</td>
                <th>Mobile</th>
                <td id="v_phone">â€”</td>
            </tr>
            <tr>
                <th colspan="2">Billing Address</th>
                <th colspan="2">Delivery Address</th>
            </tr>
            <tr>
               <td id="v_billing_address" colspan="2">â€”</td>
               <td id="v_delivery_address" colspan="2">â€”</td>
            </tr>
        </table>

        <div class="d-flex gap-2 mb-2 no-print">
            <button type="button" class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal" data-bs-target="#customerModal">
                + Add Customer
            </button>

            <button type="button" class="btn btn-success btn-sm" onclick="addRow()">
                + Add Item
            </button>

            <button type="button" class="btn btn-primary btn-sm"
                    data-bs-toggle="modal" data-bs-target="#chargesModal">
                + Add Charges
            </button>
        </div>

        <!-- ITEMS -->
        <table class="table table-bordered table-sm text-center" id="itemTable">
            <thead>
            <tr>
                <th>Image</th>
                <th>Description</th>
                <th>Size</th>
                <th>Sqft</th>
                <th>Qty(Box)</th>
                <th>Rate</th>
                <th>Amount</th>
                <th class="no-print">X</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- BANK + TOTAL -->
        <div class="row mt-3">
            <div class="col-7">
                <h6 class="fw-bold">Bank Details</h6>
                <ul style="font-size:12px">
                    <li><b>Bank:</b> HDFC BANK</li>
                    <li><b>A/C:</b> SRAGA INDIA LLP</li>
                    <li><b>Acc No:</b> 50200062874525</li>
                    <li><b>IFSC:</b> HDFC0001003</li>
                </ul>
            </div>

            <div class="col-5">
                <table class="table table-bordered table-sm">
                    <tr>
                        <th>Subtotal</th>
                        <td>â‚¹ <span id="subtotalValue">0</span></td>
                    </tr>
                    <tr id="discountRow" style="display:none">
                        <th id="discountLabel"></th>
                        <td>â‚¹ <span id="discountValue"></span></td>
                    </tr>
                    <tr id="cuttingRow" style="display:none">
                        <th>Cutting</th>
                        <td>â‚¹ <span id="cuttingValue"></span></td>
                    </tr>
                    <tr id="cartageRow" style="display:none">
                        <th>Cartage</th>
                        <td>â‚¹ <span id="cartageValue"></span></td>
                    </tr>
                    <tr id="packingRow" style="display:none">
                        <th>Packing</th>
                        <td>â‚¹ <span id="packingValue"></span></td>
                    </tr>
                    <tr id="gstRow" style="display:none">
                        <th id="gstLabel"></th>
                        <td>â‚¹ <span id="gstValue"></span></td>
                    </tr>
                    <tr class="table-secondary fw-bold">
                        <th>Grand Total</th>
                        <td>â‚¹ <span id="grandTotalValue">0</span></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- TERMS -->
        <h6 class="fw-bold mt-3">Terms & Conditions</h6>
        <ul style="font-size:12px">
            <li>Payment 100% advance</li>
            <li>Delivery 10â€“15 days</li>
            <li>No return after delivery</li>
            <li>Delhi jurisdiction</li>
        </ul>

        <!-- HIDDEN INPUTS -->
        <input type="hidden" name="subtotal" id="subtotalInput">
        <input type="hidden" name="discount" id="discountInput">
        <input type="hidden" name="gst" id="gstInput">
        <input type="hidden" name="cutting" id="cuttingInput">
        <input type="hidden" name="cartage" id="cartageInput">
        <input type="hidden" name="packing" id="packingInput">
        <input type="hidden" name="grand_total" id="grandTotalInput">

        <!-- ðŸ‘‡ ADD THESE HERE -->
        <input type="hidden" name="customer_company" id="customer_company">
        <input type="hidden" name="customer_name" id="customer_name">
        <input type="hidden" name="customer_gstin" id="customer_gstin">
        <input type="hidden" name="customer_phone" id="customer_phone">
        <input type="hidden" name="customer_sales_person" id="customer_sales_person">
        <input type="hidden" name="billing_address" id="billing_address">
        <input type="hidden" name="delivery_address" id="delivery_address">

        <div class="text-center mt-3 no-print">
            <button class="btn btn-primary px-5">Save Quotation</button>
        </div>

    </div>
</form>

<!-- CUSTOMER MODAL -->
<div class="modal fade" id="customerModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Add / Select Customer</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row g-2">

                    <!-- Basic Details -->
                    <div class="col-6">
                        <label>Company</label>
                        <input id="cust_company" class="form-control">
                    </div>

                    <div class="col-6">
                        <label>Client</label>
                        <input id="cust_name" class="form-control">
                    </div>

                    <div class="col-6">
                        <label>GST</label>
                        <input id="cust_gst" class="form-control">
                    </div>

                    <div class="col-6">
                        <label>Mobile</label>
                        <input id="cust_phone" class="form-control">
                    </div>

                    <div class="col-6">
                        <label>Sales Person</label>
                        <select id="cust_sales" class="form-select">
                            <option value="">-- Select --</option>
                            {% for u in sales_users %}
                            <option value="{{ u.username }}">{{ u.username }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Billing Address -->
                    <div class="col-12 mt-3">
                        <label><strong>Billing Address</strong></label>
                        <textarea id="cust_billing_address"
                                  class="form-control"
                                  rows="3"
                                  placeholder="Enter billing address"
                                  oninput="syncBillingToDelivery()"></textarea>
                    </div>

                    <!-- Same as Billing Checkbox -->
                    <div class="col-12">
                        <div class="form-check mt-1">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="same_as_billing"
                                   onclick="toggleSameAsBilling()">
                            <label class="form-check-label" for="same_as_billing">
                                Delivery address same as Billing
                            </label>
                        </div>
                    </div>

                    <!-- Delivery Address -->
                    <div class="col-12">
                        <label><strong>Delivery Address</strong></label>
                        <textarea id="cust_delivery_address"
                                  class="form-control"
                                  rows="3"
                                  placeholder="Enter delivery address"></textarea>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="applyCustomer()">
                    Use Customer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CHARGES MODAL -->
<div class="modal fade" id="chargesModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>Add Charges</h5></div>
            <div class="modal-body">
                <label>Discount (%)</label><input id="discountPercent" class="form-control mb-1" value="0">
                <label>GST (%)</label><input id="gstPercent" class="form-control mb-1" value="18">
                <label>Cutting</label><input id="cuttingCharges" class="form-control mb-1" value="0">
                <label>Cartage</label><input id="cartageCharges" class="form-control mb-1" value="0">
                <label>Packing</label><input id="packingCharges" class="form-control mb-1" value="0">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="updateTotals()" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
</div>

<script>
    function addRow() {
        const tbody=document.querySelector("#itemTable tbody");
        const tr=document.createElement("tr");
        tr.innerHTML=`
        <td><input type="file" name="image[]" class="form-control"></td>
        <td><input name="description[]" class="form-control"></td>
        <td><input name="size[]" class="form-control"></td>
        <td><input name="sqft[]" class="form-control" value="0" oninput="calc(this)"></td>
        <td><input name="qty_box[]" class="form-control" value="0" oninput="calc(this)"></td>
        <td><input name="rate[]" class="form-control" value="0" oninput="calc(this)"></td>
        <td><input name="amount[]" class="form-control" readonly></td>
        <td class="no-print"><button type="button" class="btn btn-danger btn-sm"
        onclick="this.closest('tr').remove()">Ã—</button></td>`;
        tbody.appendChild(tr);
    }

    function calc(el){
        const r=el.closest("tr");
        const sqft=+r.children[3].firstChild.value||0;
        const qty=+r.children[4].firstChild.value||0;
        const rate=+r.children[5].firstChild.value||0;
        r.children[6].firstChild.value=(sqft*qty*rate).toFixed(2);
        updateTotals();
    }

    function updateTotals(){
        let sub=0;
        document.querySelectorAll('[name="amount[]"]').forEach(i=>sub+=+i.value||0);
        const d=+discountPercent.value||0;
        const g=+gstPercent.value||0;
        const c=+cuttingCharges.value||0;
        const ca=+cartageCharges.value||0;
        const p=+packingCharges.value||0;
        const disc=sub*d/100;
        const gst=(sub-disc)*g/100;
        const total=sub-disc+gst+c+ca+p;

        subtotalValue.innerText=sub.toFixed(2);
        discountRow.style.display=disc>0?'':'none';
        discountLabel.innerText=`Discount (${d}%)`;
        discountValue.innerText=disc.toFixed(2);
        cuttingRow.style.display=c>0?'':'none';
        cuttingValue.innerText=c;
        cartageRow.style.display=ca>0?'':'none';
        cartageValue.innerText=ca;
        packingRow.style.display=p>0?'':'none';
        packingValue.innerText=p;
        gstRow.style.display=gst>0?'':'none';
        gstLabel.innerText=`GST (${g}%)`;
        gstValue.innerText=gst.toFixed(2);
        grandTotalValue.innerText=total.toFixed(2);

        subtotalInput.value=sub;
        discountInput.value=disc;
        gstInput.value=gst;
        cuttingInput.value=c;
        cartageInput.value=ca;
        packingInput.value=p;
        grandTotalInput.value=total;
    }

    function toggleSameAsBilling() {
        const billing = document.getElementById('cust_billing_address').value;
        const delivery = document.getElementById('cust_delivery_address');
        const checkbox = document.getElementById('same_as_billing');

        if (checkbox.checked) {
            delivery.value = billing;
            delivery.setAttribute("readonly", true);
        } else {
            delivery.removeAttribute("readonly");
            delivery.value = "";
        }
    }

    // Auto-sync when typing billing address
    function syncBillingToDelivery() {
        const checkbox = document.getElementById('same_as_billing');
        if (checkbox.checked) {
            document.getElementById('cust_delivery_address').value =
                document.getElementById('cust_billing_address').value;
        }
    }


    function applyCustomer() {
        // Preview table
        v_company.innerText = cust_company.value || 'â€”';
        v_name.innerText    = cust_name.value || 'â€”';
        v_gst.innerText     = cust_gst.value || 'â€”';
        v_phone.innerText   = cust_phone.value || 'â€”';
        v_sales.innerText   = cust_sales.value || 'â€”';
        v_billing_address.innerText  = cust_billing_address.value || 'â€”';
        v_delivery_address.innerText = cust_delivery_address.value || 'â€”';

        // ðŸ”¥ VERY IMPORTANT: hidden inputs (THIS WAS MISSING)
        customer_company.value        = cust_company.value;
        customer_name.value           = cust_name.value;
        customer_gstin.value          = cust_gst.value;
        customer_phone.value          = cust_phone.value;
        customer_sales_person.value   = cust_sales.value;
        billing_address.value         = cust_billing_address.value;
        delivery_address.value        = cust_delivery_address.value;

        // Close modal
        bootstrap.Modal.getInstance(customerModal).hide();
    }
</script>

{% endblock %}
