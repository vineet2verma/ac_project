{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block navbartitle %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-3">

    <!-- ================= PAGE HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">ERP Dashboard</h5>
        <span class="text-muted small">Overview</span>
    </div>

    <!-- ================= ORDER SUMMARY ================= -->
    <div class="row g-3 mb-4">

        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <small>Total Orders</small>
                    <h3 class="text-primary fw-bold">
                        {{ order_status.total_orders }}
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <small>Pending Orders</small>
                    <h3 class="text-warning fw-bold">
                        {{ order_status.pending_orders }}
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <small>Completed Orders</small>
                    <h3 class="text-success fw-bold">
                        {{ order_status.complete_orders }}
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <small>Reorder Required</small>
                    <h3 class="text-danger fw-bold">
                        {{ reorder_count }}
                    </h3>
                </div>
            </div>
        </div>

    </div>

    <!-- ================= ORDER STAGE STATUS ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <strong>Order Stage Status (Pending)</strong>
        </div>
        <div class="card-body">
            <div class="row text-center">

                <div class="col">
                    <small>Design</small>
                    <h4 class="text-primary">{{ order_stage_status.design }}</h4>
                </div>

                <div class="col">
                    <small>Machine</small>
                    <h4 class="text-warning">{{ order_stage_status.machine }}</h4>
                </div>

                <div class="col">
                    <small>Inventory</small>
                    <h4 class="text-info">{{ order_stage_status.inventory }}</h4>
                </div>

                <div class="col">
                    <small>QC</small>
                    <h4 class="text-danger">{{ order_stage_status.qc }}</h4>
                </div>

                <div class="col">
                    <small>Dispatch</small>
                    <h4 class="text-success">{{ order_stage_status.dispatch }}</h4>
                </div>

            </div>
        </div>
    </div>

    <!-- ================= SALES PERSON WISE ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <strong>Sales Person – Order Status</strong>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th>Sales Person</th>
                    <th class="text-center">Pending</th>
                    <th class="text-center">Completed</th>
                </tr>
                </thead>
                <tbody>
                {% for person, stats in sales_person_stats.items %}
                <tr>
                    <td>{{ person }}</td>
                    <td class="text-center text-warning fw-bold">
                        {{ stats.pending }}
                    </td>
                    <td class="text-center text-success fw-bold">
                        {{ stats.complete }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        No data available
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ================= MACHINE REPORT (LAST 5 DAYS) ================= -->
    <div class="card shadow-sm">
        <div class="card-header">
            <strong>Machine Report – Last 5 Days</strong>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Machine</th>
                    <th>Orders Worked</th>
                    <th class="text-center">ONTIME (hrs)</th>
                    <th class="text-center">DOWNTIME (hrs)</th>
                </tr>
                </thead>
                <tbody>
                {% for r in machine_reports %}
                <tr>
                    <td>{{ r.date }}</td>

                    <td>
                        <strong>{{ r.machine_name }}</strong>
                    </td>

                    <!-- ✅ MULTIPLE ORDERS -->
                    <td>
                        {% if r.orders %}
                        <ul class="mb-0 ps-3">
                            {% for order in r.orders %}
                            <li>{{ order }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <span class="text-muted">—</span>
                        {% endif %}
                    </td>

                    <td class="text-center text-success fw-bold">
                        {{ r.ontime }}
                    </td>

                    <td class="text-center text-danger fw-bold">
                        {{ r.downtime }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        No machine data available
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ================= INVENTORY LEDGER : LAST 5 DAYS ================= -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <strong>Inventory Ledger – Last 5 Days (IN / OUT)</strong>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th class="text-center text-success">IN Qty</th>
                    <th class="text-end text-success">IN Amount</th>
                    <th class="text-center text-danger">OUT Qty</th>
                    <th class="text-end text-danger">OUT Amount</th>
                    <th class="text-end">Net Impact</th>
                </tr>
                </thead>
                <tbody>
                {% for r in inv_5day_summary %}
                <tr>
                    <td>{{ r.date }}</td>

                    <td class="text-center fw-bold text-success">
                        {{ r.in_qty }}
                    </td>
                    <td class="text-end text-success fw-bold">
                        ₹ {{ r.in_amount }}
                    </td>

                    <td class="text-center fw-bold text-danger">
                        {{ r.out_qty }}
                    </td>
                    <td class="text-end text-danger fw-bold">
                        ₹ {{ r.out_amount }}
                    </td>

                    <td class="text-end fw-bold
                        {% if r.net_amount < 0 %}text-danger{% else %}text-success{% endif %}">
                        ₹ {{ r.net_amount }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No ledger data for last 5 days
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ================= ORDER LIFECYCLE SUMMARY ================= -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <strong>Pending Order – Complete Lifecycle Summary</strong>
        </div>

        <div class="accordion" id="orderAccordion">

            {% for o in order_lifecycle %}
            <div class="accordion-item">

                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ forloop.counter }}">

                        <strong>{{ o.title }}</strong>
                        &nbsp;|&nbsp; {{ o.party }}
                        &nbsp;|&nbsp; {{ o.sales_person }}
                        &nbsp;|&nbsp;
                        <span class="badge bg-warning">{{ o.status }}</span>
                    </button>
                </h2>

                <div id="collapse{{ forloop.counter }}"
                     class="accordion-collapse collapse"
                     data-bs-parent="#orderAccordion">

                    <div class="accordion-body">

                        <table class="table table-sm table-bordered mb-0">
                            <tbody>

                            <tr>
                                <th width="30%">Design</th>
                                <td>
                                    {{ o.design_days }} days
                                </td>
                            </tr>

                            <tr>
                                <th>Machine</th>
                                <td>
                                    {{ o.machine_hours }} hrs
                                    | Cost ₹ {{ o.machine_cost }}
                                </td>
                            </tr>

                            <tr>
                                <th>Inventory</th>
                                <td>
                                    {{ o.inventory_items }} items
                                    | Cost ₹ {{ o.inventory_cost }}
                                </td>
                            </tr>

                            <tr>
                                <th>QC</th>
                                <td>
                                    {{ o.qc_date|default:"Pending" }}
                                </td>
                            </tr>

                            <tr>
                                <th>Dispatch</th>
                                <td>
                                    {{ o.dispatch_date|default:"Pending" }}
                                </td>
                            </tr>

                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
            {% empty %}
            <div class="p-3 text-center text-muted">
                No pending orders
            </div>
            {% endfor %}

        </div>
    </div>

</div>
{% endblock %}
