{% extends 'base.html' %}
{% block title %}CNC Details{% endblock %}
{% block navbartitle %}CNC Details{% endblock %}
{% block content %}

<style>
    /* ================= MOBILE RESPONSIVE ERP ================= */

    @media (max-width: 768px) {
      .erp-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 10px;
      }

      .erp-header-right {
        align-self: flex-start;
      }

      .order-image {
        max-width: 100% !important;
        margin-bottom: 10px;
      }

      .table-responsive {
        overflow-x: auto;
      }

      .action-btn-group {
        flex-wrap: wrap;
      }
    }
    /* ================= PRINT PDF ================= */
    @media print {
            body {
                background: #fff !important;
            }
            .btn,
            .action-btn-group,
            .modal,
            .erp-header-right,
            .no-print {
                display: none !important;
            }
            table {
                font-size: 12px !important;
            }
            .order-image {
                max-width: 300px !important;
                margin-bottom: 10px;
            }
            .container {
                max-width: 100% !important;
            }
        }
</style>

<div class="container-fluid py-3">
    <!-- ================= ERP HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom erp-header">

        <div class="d-flex align-items-center gap-3">
            <div>
                <a href="{% url 'cnc_work_app:index' %}" class="btn btn-outline-secondary btn-sm rounded-circle">
                    <i class="bi bi-arrow-return-left"></i>
                </a>
            </div>
            <div class="d-flex align-items-center gap-4">
                <h5 class="fw-semibold text-primary m-0">
                    Title : <span class="badge bg-warning text-dark  "> {{ order.title }} </span> || <span class="badge bg-secondary "> {{ order.sales_person|title }} </span> || <span class="badge bg-info text-dark }}" > {{ order.type_of_work  }} </span>
                </h5>
                <!-- ‚úèÔ∏è EDIT ORDER -->
                {% if is_admin %}
                <button
                        class="btn btn-outline-primary btn-sm rounded-circle"
                        data-bs-toggle="modal"
                        data-bs-target="#editOrderModal"
                >
                    <i class="bi bi-pencil"></i>
                </button>
                {% endif %}
            </div>
        </div>

        <div class="erp-header-right d-flex gap-2 align-items-center">
            <!-- üí∞ ORDER COSTING -->
            {% if is_admin %}
            <a href="{% url 'order_costing_app:order_costing' order.id %}"
               class="btn btn-outline-primary btn-sm">
                üí∞ Order Costing
            </a>
            {% endif %}
            <button class="btn btn-outline-dark btn-sm" onclick="window.print()">
                <i class="bi bi-printer"></i> Print
            </button>
            <span class="badge {{ order.status_badge }}">
                {{ order.display_status }}
            </span>
        </div>
    </div>

    <!-- ================= IMAGE + ORDER INFO ================= -->
    <div class="row mb-4">
        <div class="col-md-4 text-center">
            {% if order.image %}
            <img
                    src="{{ order.image }}"
                    class="img-fluid rounded border order-image"
                    alt="{{ order.title }}"
            />
            {% else %}
            <p class="text-muted small">No Image</p>
            {% endif %}
        </div>

        <div class="col-md-8 table-responsive">
            <table class="table table-sm table-bordered">
                <tbody>
                <tr>
                    <th>Design</th>
                    <td>{{ order.title }}</td>
                </tr>
                <tr>
                    <th>Stone</th>
                    <td>{{ order.stone }}</td>
                </tr>
                <tr>
                    <th>Color</th>
                    <td>{{ order.color }}</td>
                </tr>
                <tr>
                    <th>Approval Date</th>
                    <td>{{ order.approval_date|date:"M d, Y " }}</td>
                </tr>
                <tr>
                    <th>Expected Delivery</th>
                    <td>{{ order.exp_delivery_date|date:"M d, Y " }}</td>
                </tr>
                <tr>
                    <th>Coverage Area</th>
                    <td>{{ order.coverage_area }}</td>
                </tr>
                <tr>
                    <th>Party Name</th>
                    <td>{{ order.party_name }}</td>
                </tr>
                <tr>
                    <th>Packing</th>
                    <td>{{ order.packing_instruction }}</td>
                </tr>
                <tr>
                    <th>Sales</th>
                    <td>{{ order.sales_person|title }}</td>
                </tr>
                <tr>
                    <th>Type of Work </th>
                    <td>{{ order.type_of_work|title }}</td>
                </tr>
                <tr>
                    <th>Remarks</th>
                    <td>{{ order.remarks }}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ================= DESIGN FILES ================= -->
    {% if can_qc or can_designer    %}
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0">Design Files</h5>
            {% if can_designer %}
            <button class="btn btn-primary btn-sm rounded-pill"
                    data-bs-toggle="modal"
                    data-bs-target="#designModal">
                + Add Design
            </button>
            {% endif %}
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-striped mt-2 align-middle">
                <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>File</th>
                    <th>Status</th>
                    <th>Approved By</th>
                    <th>Date</th>
                    <th style="width:140px">Action</th>
                </tr>
                </thead>

                <tbody>
                {% for file in design_files %}
                <tr>
                    <td>{{ file.name }}</td>

                    <td>
                        <a href="{{ file.file_url }}" target="_blank"
                           class="btn btn-outline-secondary btn-sm">
                            View
                        </a>
                    </td>

                    <td>
                        <span class="badge
                            {% if file.status == 'approved' %} bg-success
                            {% elif file.status == 'cancelled' %} bg-danger
                            {% else %} bg-warning text-dark {% endif %}">
                            {{ file.status|title }}
                        </span>
                    </td>
                    <td>
                        {{ file.approved_by_name|default:"-" }}
                    </td>

                    <td>{{ file.approved_at|date:"Y-M-d h:i A "|default:"-" }}</td>

                    <td>
                        <div class="d-flex gap-1 action-btn-group">

                            {% if file.status == "pending" %}
                            <!-- APPROVE -->
                            <button class="btn btn-success btn-sm"
                                    title="Approve"
                                    onclick="designAction('{{ file.id }}','approve')">
                                <i class="bi bi-check-lg"></i>
                            </button>

                            <!-- CANCEL -->
                            <button class="btn btn-warning btn-sm"
                                    title="Cancel"
                                    onclick="designAction('{{ file.id }}','cancel')">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            {% endif %}

                            <!-- DELETE -->
                            {% if is_admin %}
                                <!-- Admin can delete anytime (even approved) -->
                                <form method="POST"
                                      action="{% url 'design_app:design_delete' order.id file.id %}">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="btn btn-danger btn-sm"
                                            title="Delete"
                                            onclick="return confirm('Delete this design file?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>

                            {% elif can_designer and file.status in "pending cancelled" %}
                                <!-- Other users can delete only if pending/cancelled -->
                                <form method="POST"
                                      action="{% url 'design_app:design_delete' order.id file.id %}">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="btn btn-danger btn-sm"
                                            title="Delete"
                                            onclick="return confirm('Delete this design file?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            {% endif %}

                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        No design files
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}


    <!-- ================= INVENTORY ================= -->
    {% if can_qc or can_inventory %}
    <div class=" mb-4">
        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-center">
            <h5>Inventory</h5>
        </div>

        <!-- QUICK ACTIONS -->
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2 mt-2">
                <a href="{% url 'inv_app:check' order.id %}"
                   class="btn btn-outline-primary btn-sm">
                    Inventory Check
                </a>
                <a href="{% url 'inv_app:pr_list' order.id %}"
                   class="btn btn-outline-warning btn-sm">
                    PR List
                </a>
            </div>
            <button class="btn btn-success btn-sm px-4 "
                    data-bs-toggle="modal"
                    data-bs-target="#inventoryModal">
                + Add
            </button>
        </div>

        <!-- TABLE -->
        <div class="table-responsive mt-2">
            <table class="table table-sm table-bordered align-middle">
                <thead class="table-light">
                <tr>
                    <th>Item</th>
                    <th class="text-end">Required</th>
                    <th class="text-end">Reserved</th>
                    <th>Status</th>
                    <th width="160">Action</th>
                </tr>
                </thead>
                <tbody>

                {% for inv in order_inventory %}
                <tr>
                    <td>{{ inv.item_name }}</td>
                    <td class="text-end">{{ inv.required_qty }}</td>
                    <td class="text-end">{{ inv.reserved_qty|default:"-" }}</td>
                    <td>
                        {% if inv.status == "PENDING" %}
                        <span class="badge bg-secondary">Pending</span>
                        {% elif inv.status == "SHORTAGE" %}
                        <span class="badge bg-danger">Shortage</span>
                        {% elif inv.status == "PR_CREATED" %}
                        <span class="badge bg-warning text-dark">PR Created</span>
                        {% elif inv.status == "AVAILABLE" %}
                        <span class="badge bg-success">Available</span>
                        {% elif inv.status == "RESERVED" %}
                        <span class="badge bg-primary">Reserved</span>
                        {% endif %}
                    </td>

                    <td class="text-center">

                        <!-- DELETE -->
                        {% if inv.status == "PENDING" %}
                        <form method="POST"
                              action="{% url 'inv_app:delete_inventory' order.id inv.id %}"
                              class="d-inline">
                            {% csrf_token %}
                            <button class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>

                        <!-- CREATE PR (POST ‚Äì FIXED) -->
                        {% elif inv.status == "SHORTAGE" %}
                        <form method="POST"
                              action="{% url 'inv_app:create_pr' inv.id %}"
                              class="d-inline">
                            {% csrf_token %}
                            <button class="btn btn-outline-warning btn-sm">
                                <i class="bi bi-cart-plus"></i> Create PR
                            </button>
                        </form>

                        <!-- RESERVE -->
                        {% elif inv.status == "AVAILABLE" %}
                        <form method="POST"
                              action="{% url 'inv_app:inventory_reserve' inv.id %}"
                              class="d-inline">
                            {% csrf_token %}
                            <button class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-lock-fill"></i> Reserve
                            </button>
                        </form>

                        {% else %}
                        <span class="text-muted small">Locked</span>
                        {% endif %}

                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        No inventory added
                    </td>
                </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>

<!-- ================= MACHINE DETAILS ================= -->
{% if can_production %}
<div class="mb-4">
    <div class="d-flex justify-content-between">
        <h5>Machine Details</h5>
        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#machineModal">
            + Add Machine
        </button>
    </div>

    <table class="table table-sm table-bordered mt-2">
        <thead class="table-light">
        <tr>
            <th>Date</th>
            <th>Machine</th>
            <th>Type</th>
            <th>Hours</th>
            <th>Operator</th>
            <th>Status</th>
            <th width="160">Action</th>
        </tr>
        </thead>

        <tbody>
        {% for m in machines %}
        <tr>
            <td>{{ m.work_date }}</td>
            <td>{{ m.machine_name }}</td>
            <td>
              <span class="badge {% if m.work_type == 'DOWNTIME' %}bg-danger{% else %}bg-success{% endif %}">
                {{ m.work_type }}
              </span>
            </td>
            <td>{{ m.working_hour }}</td>
            <td>{{ m.operator|default:"-" }}</td>
            <td>
                {% if m.status == "PENDING" %}
                <span class="badge bg-secondary">Pending</span>
                {% elif m.status == "IN_PROGRESS" %}
                <span class="badge bg-warning text-dark">In Progress</span>
                {% else %}
                <span class="badge bg-success">Completed</span>
                {% endif %}
            </td>
            <td class="text-center">

                {% if m.status == "PENDING" %}
                <form method="post" action="{% url 'machine_app:machine_work_start' order.id m.id %}"
                      style="display:inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-success">Start</button>
                </form>

                <form method="post" action="{% url 'machine_app:machine_delete' order.id m.id %}"
                      style="display:inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-danger"
                            onclick="return confirm('Delete this entry?')">Delete
                    </button>
                </form>

                {% elif m.status == "IN_PROGRESS" %}
                <form method="post" action="{% url 'machine_app:machine_work_complete' order.id m.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-primary">Complete</button>
                </form>
                {% else %}
                ‚Äî
                {% endif %}

            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" class="text-center text-muted">No machine work</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% endif %}

<!-- ================= QUALITY CHECK ================= -->
{% if can_qc %}
<div class="mb-4">
    <h5 class="mb-2">QC Check</h5>

    <form method="POST" action="{% url 'cnc_work_app:quality_check' order.id %}" class="card card-body mb-2">
        {% csrf_token %}
        <div class="row g-2">
            <div class="col-md-3">
                <input name="checked_by" class="form-control form-control-sm" placeholder="Checked By" required></div>
            <div class="col-md-3">
                <select name="status" class="form-select form-select-sm">
                    <option value="pass">Pass</option>
                    <option value="fail">Fail</option>
                </select>
            </div>
            <div class="col-md-4"><input name="remarks" class="form-control form-control-sm" placeholder="Remarks">
            </div>
            <div class="col-md-2">
                <button class="btn btn-success btn-sm w-100">Submit</button>
            </div>
        </div>
    </form>

    {% if quality_checks %}
    <table class="table table-sm table-bordered">
        <thead class="table-light">
        <tr>
            <th>Date</th>
            <th>Checked By</th>
            <th>Status</th>
            <th>Remarks</th>
        </tr>
        </thead>
        <tbody>
        {% for q in quality_checks %}
        <tr>
            <td>{{ q.checked_at|date:"Y-M-d"|default:"-" }}</td>
            <td>{{ q.checked_by }}</td>
            <td>
          <span class="badge {% if q.status == 'pass' %}bg-success{% else %}bg-danger{% endif %}">
            {{ q.status|upper }}
          </span>
            </td>
            <td>{{ q.remarks|default:"-" }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted small">No quality checks</p>
    {% endif %}
</div>
{% endif %}

<!-- ================= DISPATCH ================= -->
{% if can_dispatch %}
<div class="mb-4">
    <h5 class="mb-2">Dispatch</h5>
    <form method="POST" action="{% url 'cnc_work_app:dispatch_add' order.id %}" class="card card-body mb-2">
        {% csrf_token %}
        <div class="row g-2">
            <div class="col-md-2"><input name="vehicle_no" class="form-control form-control-sm"
                                         placeholder="Vehicle No" required></div>
            <div class="col-md-2"><input name="lr_no" class="form-control form-control-sm" placeholder="LR No"
                                         required></div>
            <div class="col-md-3"><input type="date" name="dispatch_date" class="form-control form-control-sm"
                                         required></div>
            <div class="col-md-3"><input name="dispatched_by" class="form-control form-control-sm"
                                         placeholder="Dispatched By"></div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-sm w-100">Dispatch</button>
            </div>
        </div>
    </form>

    {% if dispatches %}
    <table class="table table-sm table-bordered">
        <thead class="table-light">
        <tr>
            <th>Date</th>
            <th>Vehicle</th>
            <th>LR</th>
            <th>By</th>
            <th>Remarks</th>
        </tr>
        </thead>
        <tbody>
        {% for d in dispatches %}
        <tr>
            <td>{{ d.dispatch_date }}</td>
            <td>{{ d.vehicle_no }}</td>
            <td>{{ d.lr_no }}</td>
            <td>{{ d.dispatched_by|default:"-" }}</td>
            <td>{{ d.remarks|default:"-" }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted small">No dispatch records</p>
    {% endif %}
</div>
{% endif %}


</div>

<!-- MODALS -->
{% include 'cnc_work_app/order_edit.html' %}

{% include 'design_app/design_add.html' %}
{% include 'inv_app/inventory_add.html' %}

{% include 'machine_app/m_add_edit.html' %}


<script>
    function downloadOrderImage() {
        const imgUrl = "{{ order.image }}";
        if (!imgUrl) return;
    
        const a = document.createElement("a");
        a.href = imgUrl;
        a.download = "{{ order.title|slugify }}.jpg";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    /* ================= PRINT AS PDF ================= */
    function printOrderPDF() {
        window.print();
    }
</script>


<script>
    document.querySelectorAll(".edit-machine-btn").forEach(btn => {
      btn.addEventListener("click", function () {

        document.getElementById("machineModalTitle").innerText = "‚úèÔ∏è Edit Machine Work";

        document.getElementById("machine_work_id").value = this.dataset.id;
        document.getElementById("machine_id").value = this.dataset.machineId;
        document.getElementById("id_working_hour").value = this.dataset.hours;
        document.getElementById("id_operator").value = this.dataset.operator || "";
        document.getElementById("id_remarks").value = this.dataset.remarks || "";
        document.getElementById("id_work_type").value = this.dataset.type;

      });
    });

    // Reset modal when adding new
    document.getElementById("machineModal").addEventListener("hidden.bs.modal", function () {
      document.getElementById("machineModalTitle").innerText = "üõ†Ô∏è Add Machine Work";
      document.getElementById("machineWorkForm").reset();
      document.getElementById("machine_work_id").value = "";
    });
</script>


<script>
    // DESIGN FILE ACTION
    function getCSRF() {
      return document.querySelector("[name=csrfmiddlewaretoken]").value;
    }

    function designAction(id, action) {
        if (!confirm(`Are you sure you want to ${action} this design?`)) return;

        fetch(`/design-file/${id}/${action}/`, {
            method: "POST",
            credentials: "same-origin",   // üî• REQUIRED for Django session
            headers: {
                "X-CSRFToken": getCSRF(),
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => {
            if (!response.ok) throw new Error("Request failed");
            return response.json();
        })
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || "Action failed");
            }
        })
        .catch(() => alert("Action failed"));
    }


</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    
        const searchInput = document.getElementById("inventorySearch");
        const inventorySelect = document.getElementById("inventory_id");
        const availableStock = document.getElementById("available_stock");
        const qtyInput = document.getElementById("consume_qty");
        const alertBox = document.getElementById("stockAlert");
        const saveBtn = document.getElementById("saveBtn");
    
        let maxStock = 0;
    
        /* ================= SEARCH + AUTO OPEN ================= */
        searchInput.addEventListener("input", function () {
            const q = this.value.toLowerCase();
            let firstMatch = null;
    
            Array.from(inventorySelect.options).forEach(opt => {
                if (!opt.value) return;
    
                const match = opt.text.toLowerCase().includes(q);
                opt.style.display = match ? "" : "none";
    
                if (match && !firstMatch) {
                    firstMatch = opt;
                }
            });
    
            /* AUTO SELECT + FOCUS DROPDOWN */
            if (firstMatch) {
                inventorySelect.value = firstMatch.value;
                inventorySelect.focus();
    
                /* üîΩ simulate arrow down to open dropdown */
                inventorySelect.dispatchEvent(
                    new KeyboardEvent("keydown", { key: "ArrowDown" })
                );
            }
        });
    
        /* ================= STOCK LOAD ================= */
        inventorySelect.addEventListener("change", function () {
            const selected = this.options[this.selectedIndex];
            maxStock = parseFloat(selected.dataset.stock || 0);
    
            availableStock.value = maxStock;
            qtyInput.value = "";
            qtyInput.classList.remove("is-invalid");
            alertBox.classList.add("d-none");
            saveBtn.disabled = false;
        });
    
        /* ================= QTY VALIDATION ================= */
        qtyInput.addEventListener("input", function () {
            const qty = parseFloat(this.value || 0);
    
            if (qty > maxStock) {
                this.classList.add("is-invalid");
                alertBox.classList.remove("d-none");
                saveBtn.disabled = true;
            } else {
                this.classList.remove("is-invalid");
                alertBox.classList.add("d-none");
                saveBtn.disabled = false;
            }
        });
    
        /* ================= RESET ON MODAL OPEN ================= */
        document.getElementById("inventoryModal")
            .addEventListener("show.bs.modal", function () {
    
            searchInput.value = "";
            inventorySelect.value = "";
            availableStock.value = "";
            qtyInput.value = "";
            alertBox.classList.add("d-none");
            saveBtn.disabled = false;
    
            Array.from(inventorySelect.options)
                .forEach(opt => opt.style.display = "");
        });
    
    });
</script>


{% endblock %}
