{% extends 'base.html' %}
{% block title %}CNC Order{% endblock %}
{% block navbartitle %}CNC Order{% endblock %}
{% block content %}

<style>
    /* ================= MOBILE RESPONSIVE ERP ================= */

    @media (max-width: 768px) {
      .erp-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 10px;
      }

      .erp-header-right {
        align-self: flex-start;
      }

      .order-image {
        max-width: 100% !important;
        margin-bottom: 10px;
      }

      .table-responsive {
        overflow-x: auto;
      }

      .action-btn-group {
        flex-wrap: wrap;
      }
    }
</style>

<div class="container py-3">
    <!-- ================= ERP HEADER ================= -->
    <div
            class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom erp-header"
    >
        <!-- LEFT -->
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <!-- BACK -->
            <a
                    href="{% url 'cnc_work_app:index' %}"
                    class="btn btn-outline-secondary btn-sm rounded-circle"
                    title="Back"
            >
                <i class="bi bi-arrow-return-left"></i>
            </a>
            
            <!-- ORDER ID -->
            
            <h5 class="m-0 fw-semibold text-primary"><span class="fw-bold">Title : </span>{{ order.title }} || {{ order.sales_person }} ||</h5>

            {% if request.session.mongo_role == "ADMIN" %}
            <!-- EDIT -->
            <button
                    class="btn btn-outline-primary btn-sm rounded-circle"
                    data-bs-toggle="modal"
                    data-bs-target="#editOrderModal"
            >
                <i class="bi bi-pencil"></i>
            </button>
            {% endif %}
        </div>
        
        <!-- RIGHT -->
        <div class="erp-header-right">
            <span class="small text-muted me-2">Status</span>
            <span
                    class="badge rounded-pill px-3 py-2 {% if order.current_status == 'Complete' %} bg-success {% elif order.current_status == 'Dispatch Pending' %} bg-primary {% elif order.current_status == 'Inventory Pending' %} bg-warning text-dark {% else %} bg-danger {% endif %}"
            >
        {{ order.current_status }}
      </span>
        </div>
    </div>
    
    <!-- ================= IMAGE + ORDER INFO ================= -->
    <div class="row mb-4">
        <div class="col-md-4 text-center">
            {% if order.image %}
            <img
                    src="{{ order.image }}"
                    class="img-fluid rounded border order-image"
                    alt="{{ order.title }}"
            />
            {% else %}
            <p class="text-muted small">No Image</p>
            {% endif %}
        </div>
        
        <div class="col-md-8 table-responsive">
            <table class="table table-sm table-bordered">
                <tbody>
                <tr>
                    <th>Design</th>
                    <td>{{ order.title }}</td>
                </tr>
                <tr>
                    <th>Stone</th>
                    <td>{{ order.stone }}</td>
                </tr>
                <tr>
                    <th>Color</th>
                    <td>{{ order.color }}</td>
                </tr>
                <tr>
                    <th>Approval Date</th>
                    <td>{{ order.approval_date }}</td>
                </tr>
                <tr>
                    <th>Expected Delivery</th>
                    <td>{{ order.exp_delivery_date }}</td>
                </tr>
                <tr>
                    <th>Coverage Area</th>
                    <td>{{ order.coverage_area }}</td>
                </tr>
                <tr>
                    <th>Party Name</th>
                    <td>{{ order.party_name }}</td>
                </tr>
                <tr>
                    <th>Packing</th>
                    <td>{{ order.packing_instruction }}</td>
                </tr>
                <tr>
                    <th>Sales</th>
                    <td>{{ order.sales_person }}</td>
                </tr>
                <tr>
                    <th>Remarks</th>
                    <td>{{ order.remarks }}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ================= DESIGN FILES ================= -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0">Design Files</h5>
            <button class="btn btn-primary btn-sm rounded-pill"
                    data-bs-toggle="modal"
                    data-bs-target="#designModal">
                + Add Design
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm table-striped mt-2 align-middle">
                <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>File</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th style="width:140px">Action</th>
                </tr>
                </thead>
                
                <tbody>
                {% for file in design_files %}
                <tr>
                    <td>{{ file.name }}</td>
                    
                    <td>
                        <a href="{{ file.file_url }}" target="_blank"
                           class="btn btn-outline-secondary btn-sm">
                            View
                        </a>
                    </td>
                    
                    <td>
                    <span class="badge
                        {% if file.status == 'approved' %} bg-success
                        {% elif file.status == 'cancelled' %} bg-danger
                        {% else %} bg-warning text-dark {% endif %}">
                        {{ file.status|title }}
                    </span>
                    </td>
                    
                    <td>{{ file.approved_at|default:"-" }}</td>
                    
                    <td>
                        <div class="d-flex gap-1 action-btn-group">
                            
                            {% if file.status == "pending" %}
                            <!-- APPROVE -->
                            <button class="btn btn-success btn-sm"
                                    title="Approve"
                                    onclick="designAction('{{ file.id }}','approve')">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            
                            <!-- CANCEL -->
                            <button class="btn btn-warning btn-sm"
                                    title="Cancel"
                                    onclick="designAction('{{ file.id }}','cancel')">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            {% endif %}
                            
                            <!-- DELETE -->
                            <form method="POST"
                                  action="{% url 'cnc_work_app:design_delete' order.id file.id %}">
                                {% csrf_token %}
                                <button type="submit"
                                        class="btn btn-danger btn-sm"
                                        title="Delete"
                                        onclick="return confirm('Delete this design file?')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        No design files
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ================= MACHINE DETAILS ================= -->
    <div class="mb-4">
        <div
                class="d-flex justify-content-between align-items-center flex-wrap gap-2"
        >
            <h5 class="mb-0">Machine Details</h5>
            
            <button
                    class="btn btn-info btn-sm rounded-pill"
                    data-bs-toggle="modal"
                    data-bs-target="#machineModal"
            >
                + Add Machine
            </button>
        </div>
        
        <div class="table-responsive mt-2">
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Machine</th>
                    <th>Hours</th>
                    <th>Operator</th>
                    <th>Remarks</th>
                    <th style="width: 90px">Action</th>
                </tr>
                </thead>
                
                <tbody>
                {% for m in machines %}
                <tr>
                    <td>{{ m.work_date }}</td>
                    <td>{{ m.machine_name }}</td>
                    <td>{{ m.working_hour }}</td>
                    <td>{{ m.operator|default:"-" }}</td>
                    <td>{{ m.remarks|default:"-" }}</td>
                    <td class="text-center">
                        <!-- EDIT -->
                        <button
                                type="button"
                                class="btn btn-link p-0 text-primary edit-machine-btn"
                                data-id="{{ m.id }}"
                                data-machine="{{ m.machine_name }}"
                                data-hours="{{ m.working_hour }}"
                                data-operator="{{ m.operator }}"
                                data-remarks="{{ m.remarks }}"
                                data-bs-toggle="modal"
                                data-bs-target="#machineModal">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        
                        
                        <!-- DELETE -->
                        <form
                                method="POST"
                                action="{% url 'cnc_work_app:machine_delete' order.id m.id %}"
                                style="display: inline"
                        >
                            {% csrf_token %}
                            <button
                                    type="submit"
                                    class="btn btn-link p-0 text-danger"
                                    onclick="return confirm('Delete this machine entry?')"
                            >
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        No machine details added
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- TOTAL HOURS -->
        <div class="text-start mt-2"> Total Working Hours:<strong> {{ total_hours }} hrs</strong>
        </div>
    </div>

    {% if request.session.mongo_role == "ADMIN" or request.session.mongo_role == "PRODUCTION" %}
    <!-- ================= INVENTORY ================= -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0">Inventory</h5>
            <button
                    class="btn btn-success btn-sm rounded-pill px-4"
                    data-bs-toggle="modal"
                    data-bs-target="#inventoryModal"
            >
                + Add
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm table-bordered mt-2">
                <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Rate</th>
                    <th>Total</th>
                    <th style="width:80px;">Action</th>
                </tr>
                </thead>
                <tbody>
                {% for inv in order_inventory %}
                <tr>
                    <td>{{ inv.item_name }}</td>
                    <td>{{ inv.qty }}</td>
                    <td>{{ inv.rate }}</td>
                    <td>{{ inv.total }}</td>
                    <td class="text-center">
                        <form method="POST"
                              action="{% url 'cnc_work_app:delete_inventory' order_id=order.id inv_id=inv.id %}"
                              onsubmit="return confirm('Delete this inventory item?');">
                            {% csrf_token %}
                            <button class="btn btn-danger btn-sm">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center text-muted">No inventory added</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- ================= QUALITY CHECK ================= -->
    <div class="mb-4">
        <h5 class="mb-2">QC Check</h5>
        
        <form method="POST" action="{% url 'cnc_work_app:quality_check' order.id %}" class="card card-body mb-2">
            {% csrf_token %}
            <div class="row g-2">
                <div class="col-md-3"><input name="checked_by" class="form-control form-control-sm"
                                             placeholder="Checked By" required></div>
                <div class="col-md-3">
                    <select name="status" class="form-select form-select-sm">
                        <option value="pass">Pass</option>
                        <option value="fail">Fail</option>
                    </select>
                </div>
                <div class="col-md-4"><input name="remarks" class="form-control form-control-sm" placeholder="Remarks">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success btn-sm w-100">Submit</button>
                </div>
            </div>
        </form>
        
        {% if quality_checks %}
        <table class="table table-sm table-bordered">
            <thead class="table-light">
            <tr>
                <th>Date</th>
                <th>Checked By</th>
                <th>Status</th>
                <th>Remarks</th>
            </tr>
            </thead>
            <tbody>
            {% for q in quality_checks %}
            <tr>
                <td>{{ q.created_at|default:"-" }}</td>
                <td>{{ q.checked_by }}</td>
                <td>
          <span class="badge {% if q.status == 'pass' %}bg-success{% else %}bg-danger{% endif %}">
            {{ q.status|upper }}
          </span>
                </td>
                <td>{{ q.remarks|default:"-" }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted small">No quality checks</p>
        {% endif %}
    </div>
    
    <!-- ================= DISPATCH ================= -->
    <div class="mb-4">
        <h5 class="mb-2">Dispatch</h5>
        
        <form method="POST" action="{% url 'cnc_work_app:dispatch_add' order.id %}" class="card card-body mb-2">
            {% csrf_token %}
            <div class="row g-2">
                <div class="col-md-2"><input name="vehicle_no" class="form-control form-control-sm"
                                             placeholder="Vehicle No" required></div>
                <div class="col-md-2"><input name="lr_no" class="form-control form-control-sm" placeholder="LR No"
                                             required></div>
                <div class="col-md-3"><input type="date" name="dispatch_date" class="form-control form-control-sm"
                                             required></div>
                <div class="col-md-3"><input name="dispatched_by" class="form-control form-control-sm"
                                             placeholder="Dispatched By"></div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100">Dispatch</button>
                </div>
            </div>
        </form>
        
        {% if dispatches %}
        <table class="table table-sm table-bordered">
            <thead class="table-light">
            <tr>
                <th>Date</th>
                <th>Vehicle</th>
                <th>LR</th>
                <th>By</th>
                <th>Remarks</th>
            </tr>
            </thead>
            <tbody>
            {% for d in dispatches %}
            <tr>
                <td>{{ d.dispatch_date }}</td>
                <td>{{ d.vehicle_no }}</td>
                <td>{{ d.lr_no }}</td>
                <td>{{ d.dispatched_by|default:"-" }}</td>
                <td>{{ d.remarks|default:"-" }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted small">No dispatch records</p>
        {% endif %}
    </div>


</div>

<!-- MODALS -->
{% include 'cnc_work_app/order_edit.html' %}
{% include 'cnc_work_app/design_add.html' %}
{% include 'machine/machine_add_update.html' %}

{% include 'inventory/inventory_add.html' %}

<script>
    document.addEventListener("DOMContentLoaded", function () {

  // EDIT MACHINE
  document.querySelectorAll(".edit-machine-btn").forEach(btn => {
  btn.addEventListener("click", function () {

    // set hidden id
    document.getElementById("machine_work_id").value = this.dataset.id;

    // fill form values
    document.getElementById("id_working_hour").value = this.dataset.hours;
    document.getElementById("id_operator").value = this.dataset.operator || "";
    document.getElementById("id_remarks").value = this.dataset.remarks || "";

    // ðŸ” change form action to EDIT
    document.querySelector("#machineModal form").action =
      `/order/{{ order.id }}/machine/${this.dataset.id}/edit/`;
  });
});

  // RESET FOR ADD
  document.getElementById("machineModal").addEventListener("hidden.bs.modal", function () {
    document.getElementById("machine_id").value = "";
    document.getElementById("machineModalTitle").innerText = "Add Machine Detail";
    this.querySelector("form").reset();
  });

});

// DESIGN FILE ACTION
function getCSRF() {
  return document.querySelector("[name=csrfmiddlewaretoken]").value;
}

function designAction(id, action) {
  fetch(`/design-file/${id}/${action}/`, {
    method: "POST",
    headers: { "X-CSRFToken": getCSRF() },
  })
    .then(() => location.reload())
    .catch(() => alert("Action failed"));
}


</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

      /* ================= INVENTORY VALIDATION ================= */

      const inventorySelect = document.getElementById("inventory_id");
      const availableStock = document.getElementById("available_stock");
      const qtyInput = document.getElementById("consume_qty");
      const alertBox = document.getElementById("stockAlert");
      const saveBtn = document.getElementById("saveBtn");

      let maxStock = 0;

      if (inventorySelect) {

        inventorySelect.addEventListener("change", function () {
          const selected = this.options[this.selectedIndex];

          maxStock = parseFloat(selected.dataset.stock || 0);
          availableStock.value = maxStock;

          qtyInput.value = "";
          qtyInput.classList.remove("is-invalid", "is-valid");
          alertBox.classList.add("d-none");
          saveBtn.disabled = false;
        });

        qtyInput.addEventListener("input", function () {
          const qty = parseFloat(this.value || 0);

          if (qty > maxStock) {
            this.classList.add("is-invalid");
            alertBox.classList.remove("d-none");
            saveBtn.disabled = true;
          } else {
            this.classList.remove("is-invalid");
            alertBox.classList.add("d-none");
            saveBtn.disabled = false;
          }
        });
      }

    });
</script>


{% endblock %}
