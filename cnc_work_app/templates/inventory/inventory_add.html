<!-- ================= INVENTORY ADD MODAL ================= -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">

    <form method="POST"
          action="{% url 'cnc_work_app:order_inventory_add' order.id %}"
          class="modal-content">

      {% csrf_token %}

      <!-- HEADER -->
      <div class="modal-header">
        <h6 class="modal-title fw-semibold">
          <i class="bi bi-box-seam me-1"></i> Add Inventory
        </h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <!-- INVENTORY ITEM -->
        <div class="mb-3">
          <label class="form-label small fw-semibold">Inventory Item</label>
          <select name="inventory_id"
                  id="inventory_id"
                  class="form-select form-select-sm"
                  required>
            <option value="">— Select Item —</option>
            {% for i in inventory_items %}
              <option value="{{ i.id }}"
                      data-stock="{{ i.current_qty }}"
                      data-unit="{{ i.unit }}">
                {{ i.item_name }} ({{ i.current_qty }} {{ i.unit }})
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- AVAILABLE STOCK -->
        <div class="mb-3">
          <label class="form-label small fw-semibold">Available Stock</label>
          <input id="available_stock"
                 class="form-control form-control-sm"
                 readonly
                 placeholder="Auto filled">
        </div>

        <!-- QTY -->
        <div class="mb-2">
          <label class="form-label small fw-semibold">Consume Quantity</label>
          <input type="number"
                 step="0.01"
                 name="qty"
                 id="consume_qty"
                 class="form-control form-control-sm"
                 placeholder="Enter qty"
                 required>

          <small id="stockAlert"
                 class="text-danger d-none">
            Qty exceeds available stock
          </small>
        </div>

      </div>

      <!-- FOOTER -->
      <div class="modal-footer">
        <button type="submit"
                id="saveBtn"
                class="btn btn-success btn-sm px-4">
          <i class="bi bi-check-circle"></i> Add
        </button>
      </div>

    </form>
  </div>
</div>

<!-- ================= INVENTORY VALIDATION JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const inventorySelect = document.getElementById("inventory_id");
  const availableStock = document.getElementById("available_stock");
  const qtyInput = document.getElementById("consume_qty");
  const alertBox = document.getElementById("stockAlert");
  const saveBtn = document.getElementById("saveBtn");

  let maxStock = 0;

  if (inventorySelect) {

    inventorySelect.addEventListener("change", function () {
      const selected = this.options[this.selectedIndex];
      maxStock = parseFloat(selected.dataset.stock || 0);

      availableStock.value = maxStock;
      qtyInput.value = "";
      qtyInput.classList.remove("is-invalid");
      alertBox.classList.add("d-none");
      saveBtn.disabled = false;
    });

    qtyInput.addEventListener("input", function () {
      const qty = parseFloat(this.value || 0);

      if (qty > maxStock) {
        this.classList.add("is-invalid");
        alertBox.classList.remove("d-none");
        saveBtn.disabled = true;
      } else {
        this.classList.remove("is-invalid");
        alertBox.classList.add("d-none");
        saveBtn.disabled = false;
      }
    });
  }
});
</script>
