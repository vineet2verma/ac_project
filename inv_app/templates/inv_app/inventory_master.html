{% extends "base.html" %}
{% block title %}Inventory Master{% endblock %}
{% block navbartitle %}Inventory Master{% endblock %}

{% block content %}
<div class="container-fluid py-1">

    <!-- ================= HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Inventory Master</h5>

        <div class="d-flex gap-2">
            <a href="{% url 'inv_app:low_stock' %}" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-exclamation-triangle"></i> Low Stock
            </a>

            <a href="{% url 'inv_app:inventory_template' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-download"></i> Template
            </a>

            <button type="button" class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
                <i class="bi bi-upload"></i> Bulk Upload
            </button>

            <button type="button" class="btn btn-success btn-sm"
                    data-bs-toggle="modal" data-bs-target="#inventoryModal">
                <i class="bi bi-plus-circle"></i> Add Item
            </button>
        </div>
    </div>

    <!-- ================= BULK UPLOAD ALERTS ================= -->
    {% if bulk_summary %}
    <div class="alert alert-info alert-dismissible fade show py-2 small">
        <strong>Bulk Upload:</strong>
        Added {{ bulk_summary.added }},
        Skipped {{ bulk_summary.skipped }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if bulk_errors %}
    <div class="alert alert-danger alert-dismissible fade show py-2 small">
        <strong>Why data not added?</strong>
        <ul class="mb-0">
            {% for err in bulk_errors %}
            <li>{{ err }}</li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- ================= FILTER / SEARCH ================= -->
    <form method="get" class="row g-2 mb-2 align-items-end">

        <div class="col-md-3">
            <label class="form-label small">Search Item</label>
            <input type="text" name="search" value="{{ search }}"
                   class="form-control form-control-sm">
        </div>

        <div class="col-md-3">
            <label class="form-label small">Category</label>
            <select name="category" class="form-select form-select-sm">
                <option value="">All Categories</option>
                {% for c in categories %}
                <option value="{{ c.category_name }}"
                        {% if c.category_name == category_filter %}selected{% endif %}>
                    {{ c.category_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small">Location</label>
            <input type="text" name="location" value="{{ location_filter }}"
                   class="form-control form-control-sm">
        </div>

        <div class="col-md-2">
            <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox"
                       name="low_stock" value="1"
                       {% if low_stock %}checked{% endif %}>
                <label class="form-check-label small">Low Stock</label>
            </div>
        </div>

        <div class="col-md-2 d-flex gap-2">
            <button class="btn btn-primary btn-sm w-100">Filter</button>
            <a href="{% url 'inv_app:inventory_master' %}"
               class="btn btn-outline-secondary btn-sm w-100">Reset</a>
        </div>
    </form>

    <!-- ================= PAGINATION TOP BAR ================= -->
    <form method="get" class="d-flex justify-content-between align-items-center mb-2">

        <div class="small text-muted">
            Showing {{ items|length }} of {{ total_count }} items
        </div>

        <!-- preserve filters -->
        <input type="hidden" name="search" value="{{ search }}">
        <input type="hidden" name="category" value="{{ category_filter }}">
        <input type="hidden" name="location" value="{{ location_filter }}">
        {% if low_stock %}
        <input type="hidden" name="low_stock" value="1">
        {% endif %}
        <input type="hidden" name="page" value="1">

        <div class="d-flex align-items-center gap-2">
            <label class="small mb-0">Rows:</label>
            <select name="per_page"
                    class="form-select form-select-sm"
                    onchange="this.form.submit()">
                {% for n in page_sizes %}
                <option value="{{ n }}"
                    {% if per_page == n %}selected{% endif %}>
                    {{ n }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- ================= INVENTORY TABLE ================= -->
    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
            <tr>
                <th>Item</th>
                <th>Category</th>
                <th>Location</th>
                <th>Unit</th>
                <th class="text-end">Stock</th>
                <th class="text-end">Rate</th>
                <th class="text-end">Reorder</th>
            </tr>
            </thead>
            <tbody>
            {% for i in items %}
            <tr>
                <td>{{ i.item_name }}</td>
                <td>{{ i.category }}</td>
                <td>{{ i.location }}</td>
                <td>{{ i.unit }}</td>
                <td class="text-end">{{ i.current_qty }}</td>
                <td class="text-end">{{ i.rate }}</td>
                <td class="text-end">{{ i.reorder_level }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">
                    No inventory items found
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ================= PAGINATION CONTROLS ================= -->
    {% if total_pages > 1 %}
    <nav class="mt-2">
        <ul class="pagination pagination-sm justify-content-end">

            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page|add:'-1' }}&per_page={{ per_page }}">
                    Prev
                </a>
            </li>
            {% endif %}

            {% for p in page_range %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link"
                   href="?page={{ p }}&per_page={{ per_page }}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}

            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page|add:'1' }}&per_page={{ per_page }}">
                    Next
                </a>
            </li>
            {% endif %}

        </ul>
    </nav>
    {% endif %}

</div>
{% endblock %}
