{% extends "base.html" %}
{% block title %}Inventory Master{% endblock %}
{% block content %}

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-semibold">Inventory Master</h4>
        <button class="btn btn-primary btn-sm rounded-pill"
                data-bs-toggle="modal"
                data-bs-target="#inventoryModal">
            + Add Item
        </button>
        <button class="btn btn-outline-primary btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#bulkUploadModal">
            ðŸ“¥ Bulk Upload
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
            <tr>
                <th>Item</th>
                <th>Category</th>
                <th>Location</th>
                <th>Unit</th>
                <th>Stock</th>
                <th>Rate</th>
                <th>Reorder</th>
                <th style="width:90px">Action</th>
            </tr>
            </thead>
            <tbody>
            {% for i in items %}
            <tr class="{% if i.current_qty <= i.reorder_level %} table-warning {% endif %}">
                <td>{{ i.item_name }}</td>
                <td>{{ i.category|default:"-" }}</td>
                <td>{{ i.location }}</td>
                <td>{{ i.unit|default:"-" }}</td>
                <td>{{ i.current_qty }}</td>
                <td>â‚¹ {{ i.rate }}</td>
                <td>{{ i.reorder_level }}</td>
                <td class="text-center">

                    <!-- EDIT -->
                    <button class="btn btn-link p-0 text-primary edit-btn"
                            data-id="{{ i.id }}"
                            data-name="{{ i.item_name }}"
                            data-category="{{ i.category }}"
                            data-location="{{ i.location }}"
                            data-unit="{{ i.unit }}"
                            data-rate="{{ i.rate }}"
                            data-reorder="{{ i.reorder_level }}"
                            data-bs-toggle="modal"
                            data-bs-target="#inventoryModal">
                        <i class="bi bi-pencil"></i>
                    </button>

                    <!-- DELETE -->
                    <a href="{% url 'inv_app:inventory_delete' i.id %}"
                       onclick="return confirm('Disable this item?')"
                       class="btn btn-link p-0 text-danger">
                        <i class="bi bi-trash"></i>
                    </a>

                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">
                    No inventory items found
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================= ADD INVENTORY MODAL ================= -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST" data-loader-text="Saving order, please waitâ€¦" class="modal-content">
            {% csrf_token %}
            <input type="hidden" name="item_id" id="item_id">

            <div class="modal-header">
                <h6 class="modal-title">Inventory Item</h6>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="mb-2">
                    <label class="form-label">Item Name</label>
                    <input name="item_name" id="item_name"
                           class="form-control form-control-sm" required>
                </div>

                <div class="row g-2">
                    <div class="col">
                        <label class="form-label">Category</label>
                        <select name="category" id="category"
                                class="form-select form-select-sm" required>
                            <option value="">Select Category</option>
                            {% for c in categories %}
                            <option value="{{ c.category_name }}">
                                {{ c.category_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label">Location</label>
                        <input name="location" id="location"
                               class="form-control form-control-sm"
                               placeholder="Godown / Warehouse / Rack"
                               required>
                    </div>
                    

                    <div class="col">
                        <label class="form-label">Unit</label>
                        <input name="unit" id="unit"
                               class="form-control form-control-sm">
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col">
                        <label class="form-label">Opening Qty</label>
                        <input type="number" step="0.01"
                               name="opening_qty" id="opening_qty"
                               class="form-control form-control-sm">
                    </div>
                    <div class="col">
                        <label class="form-label">Rate</label>
                        <input type="number" step="0.01"
                               name="rate" id="rate"
                               class="form-control form-control-sm">
                    </div>
                </div>

                <div class="mt-2">
                    <label class="form-label">Reorder Level</label>
                    <input type="number" step="0.01"
                           name="reorder_level" id="reorder_level"
                           class="form-control form-control-sm">
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-success btn-sm">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- ================= BULK UPLOAD MODAL ================= -->
<div class="modal fade" id="bulkUploadModal">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST"
              action="{% url 'inv_app:inventory_bulk_upload' %}"
              enctype="multipart/form-data"
              class="modal-content">

            {% csrf_token %}

            <div class="modal-header">
                <h6 class="modal-title">Bulk Inventory Upload</h6>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <!-- âœ… DOWNLOAD TEMPLATE -->
                <a href="{% url 'inv_app:inventory_template_download' %}"
                   class="btn btn-outline-primary btn-sm mb-3 w-100">
                    â¬‡ Download Excel Template
                </a>

                <!-- âœ… FILE INPUT -->
                <input type="file"
                       name="excel_file"
                       accept=".xlsx"
                       class="form-control"
                       required>

                <small class="text-muted d-block mt-2">
                    Upload Excel file using downloaded template only
                </small>
            </div>

            <div class="modal-footer">
                <button class="btn btn-success w-100">
                    Upload Inventory
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        item_id.value = this.dataset.id;
        item_name.value = this.dataset.name;
        category.value = this.dataset.category;
        location.value = this.dataset.location;
        unit.value = this.dataset.unit;
        rate.value = this.dataset.rate;
        reorder_level.value = this.dataset.reorder;
        opening_qty.disabled = true;
      });
    });
   
    document.getElementById("inventoryModal").addEventListener("hidden.bs.modal", () => {
      item_id.value = "";
      item_name.value = "";
      category.value = "";
      location.value = "";
      unit.value = "";
      rate.value = "";
      reorder_level.value = "";
      opening_qty.disabled = false;
    });
    
    
</script>

{% endblock %}
