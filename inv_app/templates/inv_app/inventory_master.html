{% extends "base.html" %}
{% block title %}Inventory Master{% endblock %}
{% block navbartitle %}Inventory Master{% endblock %}
{% block content %}

<div class="container-fluid py-1">
    <!-- ================= HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-1">
        <h5 class="mb-0">Inventory Master</h5>

        <div class="d-flex gap-2">
            <a href="{% url 'inv_app:low_stock' %}" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-exclamation-triangle"></i> Low Stock
            </a>

            <a href="{% url 'inv_app:inventory_template' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-download"></i> Template
            </a>

            <button class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#bulkUploadModal">
                <i class="bi bi-upload"></i> Bulk Upload
            </button>

            <button class="btn btn-success btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#inventoryModal">
                <i class="bi bi-plus-circle"></i> Add Item
            </button>
        </div>
    </div>

    <!-- ================= BULK UPLOAD ALERTS ================= -->
    {% if request.session.bulk_upload_summary %}
    <div class="alert alert-info alert-dismissible fade show py-2 small" role="alert">
        <strong>Bulk Upload:</strong>
        Added {{ request.session.bulk_upload_summary.added }},
        Skipped {{ request.session.bulk_upload_summary.skipped }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if request.session.bulk_upload_errors %}
    <div class="alert alert-danger alert-dismissible fade show py-2 small" role="alert">
        <strong>Why data not added?</strong>
        <ul class="mb-0">
            {% for err in request.session.bulk_upload_errors %}
            <li>{{ err }}</li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- ================= SUMMARY ACCORDION ================= -->
    <div class="accordion mb-2" id="inventorySummaryAccordion">

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed fw-semibold small"
                        data-bs-toggle="collapse"
                        data-bs-target="#inventorySummary">
                    <i class="bi bi-bar-chart me-2"></i>
                    Inventory Summary
                </button>
            </h2>

            <div id="inventorySummary" class="accordion-collapse collapse">
                <div class="accordion-body p-2">

                    <!-- OVERALL TOTAL -->
                    <div class="alert alert-info py-2 mb-2 small fw-semibold">
                        <span class="me-4">
                            <i class="bi bi-box-seam"></i>
                            Total Items: {{ total_items }}
                        </span>
                        <span class="me-4">
                            <i class="bi bi-stack"></i>
                            Total Stock Qty: {{ total_qty }}
                        </span>
                        <span>
                            <i class="bi bi-currency-rupee"></i>
                            Stock Value: {{ total_value }}
                        </span>
                    </div>

                    <!-- CATEGORY WISE SUMMARY -->
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Total Items</th>
                                <th class="text-end">Total Qty</th>
                                <th class="text-end">Total Value</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for c in category_summary %}
                            <tr>
                                <td>{{ c.category }}</td>
                                <td class="text-end">{{ c.total_items }}</td>
                                <td class="text-end">{{ c.total_qty }}</td>
                                <td class="text-end">{{ c.total_value }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No summary available
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- ================= FILTER / SEARCH ================= -->
    <form method="get" class="row g-2 mb-2 align-items-end">

        <div class="col-md-3">
            <label class="form-label small">Search Item</label>
            <input type="text"
                   name="search"
                   value="{{ search }}"
                   class="form-control form-control-sm"
                   placeholder="Item name">
        </div>

        <div class="col-md-3">
            <label class="form-label small">Category</label>
            <select name="category" class="form-select form-select-sm">
                <option value="">All Categories</option>
                {% for c in categories %}
                <option value="{{ c.category_name }}"
                        {% if c.category_name == category_filter %}selected{% endif %}>
                    {{ c.category_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small">Location</label>
            <input type="text"
                   name="location"
                   value="{{ location_filter }}"
                   class="form-control form-control-sm"
                   placeholder="Location">
        </div>

        <div class="col-md-2">
            <div class="form-check mt-4">
                <input class="form-check-input"
                       type="checkbox"
                       name="low_stock"
                       value="1"
                       {% if low_stock %}checked{% endif %}>
                <label class="form-check-label small">
                    Low Stock
                </label>
            </div>
        </div>

        <div class="col-md-2 d-flex gap-2">
            <button class="btn btn-primary btn-sm w-100">
                <i class="bi bi-funnel"></i> Filter
            </button>
            <a href="{% url 'inv_app:inventory_master' %}"
               class="btn btn-outline-secondary btn-sm w-100">
                Reset
            </a>
        </div>

    </form>

    <!-- ================= INVENTORY TABLE ================= -->
    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
            <tr>
                <th>Item</th>
                <th>Category</th>
                <th>Location</th>
                <th>Unit</th>
                <th class="text-end">Stock</th>
                <th class="text-end">Rate</th>
                <th class="text-end">Reorder</th>
                <th class="text-center" style="width:120px;">Action</th>
            </tr>
            </thead>
            <tbody>

            {% for i in items %}
            <tr>
                <td>{{ i.item_name }}</td>
                <td>{{ i.category }}</td>
                <td>{{ i.location }}</td>
                <td>{{ i.unit }}</td>
                <td class="text-end">{{ i.current_qty }}</td>
                <td class="text-end">{{ i.rate }}</td>
                <td class="text-end">{{ i.reorder_level }}</td>

                <td class="text-center">
                    <button type="button"
                            class="btn btn-link p-0 text-primary edit-btn"
                            data-id="{{ i.id }}"
                            data-name="{{ i.item_name }}"
                            data-category="{{ i.category }}"
                            data-location="{{ i.location }}"
                            data-unit="{{ i.unit }}"
                            data-opening="{{ i.opening_qty }}"
                            data-rate="{{ i.rate }}"
                            data-reorder="{{ i.reorder_level }}"
                            data-bs-toggle="modal"
                            data-bs-target="#inventoryModal">
                        <i class="bi bi-pencil-square"></i>
                    </button>

                    <form method="POST"
                          action="{% url 'inv_app:inventory_master_delete' i.id %}"
                          class="d-inline"
                          onsubmit="return confirm('Delete this item?');">
                        {% csrf_token %}
                        <button class="btn btn-link p-0 text-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center text-muted py-3">
                    No inventory items found
                </td>
            </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>



</div>

<!-- ================= BULK UPLOAD MODAL ================= -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title">Inventory Bulk Upload</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <form method="POST"
                      action="{% url 'inv_app:inventory_bulk_upload' %}"
                      enctype="multipart/form-data">
                    {% csrf_token %}

                    <label class="form-label small">Select Excel File</label>
                    <input type="file"
                           name="excel_file"
                           class="form-control form-control-sm"
                           accept=".xlsx"
                           required>

                    <div class="text-danger small mt-2">
                        <i class="bi bi-info-circle"></i>
                        Category name must exactly match Category Master
                    </div>


                    <button type="submit"
                            class="btn btn-primary btn-sm w-100 mt-3">
                        Upload
                    </button>
                </form>

            </div>

        </div>
    </div>
</div>

<!-- ================= ADD INVENTORY MODAL ================= -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title">Add Inventory Item</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" action="{% url 'inv_app:inventory_master_add' %}">
                {% csrf_token %}
                <div class="modal-body row g-2">

                    <div class="col-md-6">
                        <label class="form-label small">Item Name</label>
                        <input type="text" name="item_name"
                               class="form-control form-control-sm" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small">Category</label>
                        <select name="category"
                                class="form-select form-select-sm"
                                required>
                            <option value="">Select Category</option>
                            {% for c in categories %}
                            <option value="{{ c.category_name }}">
                                {{ c.category_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm"
                            data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-success btn-sm">Save</button>
                </div>
            </form>

        </div>
    </div>
</div>

{% endblock %}
