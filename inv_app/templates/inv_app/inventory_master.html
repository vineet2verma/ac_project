{% extends "base.html" %}
{% block title %}Inventory Master{% endblock %}
{% block navbartitle %}Inventory Master{% endblock %}

{% block content %}
<div class="container-fluid py-1">

    <!-- ================= HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Inventory Master</h5>

        <div class="d-flex gap-2">
            <a href="{% url 'inv_app:low_stock' %}" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-exclamation-triangle"></i> Low Stock
            </a>

            <a href="{% url 'inv_app:inventory_template' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-download"></i> Template
            </a>

            <button type="button" class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
                <i class="bi bi-upload"></i> Bulk Upload
            </button>

            <button type="button" class="btn btn-success btn-sm"
                    data-bs-toggle="modal" data-bs-target="#inventoryModal">
                <i class="bi bi-plus-circle"></i> Add Item
            </button>
        </div>
    </div>

        <!-- ================= SUMMARY ACCORDION ================= -->
    <div class="accordion mb-2" id="inventorySummaryAccordion">

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed fw-semibold small"
                        data-bs-toggle="collapse"
                        data-bs-target="#inventorySummary">
                    <i class="bi bi-bar-chart me-2"></i>
                    Inventory Summary
                </button>
            </h2>

            <div id="inventorySummary" class="accordion-collapse collapse">
                <div class="accordion-body p-2">

                    <!-- OVERALL TOTAL -->
                    <div class="alert alert-info py-2 mb-2 small fw-semibold">
                        <span class="me-4">
                            <i class="bi bi-box-seam"></i>
                            Total Items: {{ total_items }}
                        </span>
                        <span class="me-4">
                            <i class="bi bi-stack"></i>
                            Total Stock Qty: {{ total_qty }}
                        </span>
                        <span>
                            <i class="bi bi-currency-rupee"></i>
                            Stock Value: {{ total_value }}
                        </span>
                    </div>

                    <!-- CATEGORY WISE SUMMARY -->
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Total Items</th>
                                <th class="text-end">Total Qty</th>
                                <th class="text-end">Total Value</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for c in category_summary %}
                            <tr>
                                <td>{{ c.category }}</td>
                                <td class="text-end">{{ c.total_items }}</td>
                                <td class="text-end">{{ c.total_qty }}</td>
                                <td class="text-end">{{ c.total_value }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No summary available
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

    </div>


    <!-- ================= ALERTS ================= -->
    {% if bulk_summary %}
    <div class="alert alert-info alert-dismissible fade show py-2 small">
        <strong>Bulk Upload:</strong>
        Added {{ bulk_summary.added }},
        Skipped {{ bulk_summary.skipped }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if bulk_errors %}
    <div class="alert alert-danger alert-dismissible fade show py-2 small">
        <strong>Why data not added?</strong>
        <ul class="mb-0">
            {% for err in bulk_errors %}
            <li>{{ err }}</li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- ================= FILTER / SEARCH ================= -->
    <form method="get" class="row g-2 mb-2 align-items-end">

        <div class="col-md-3">
            <label class="form-label small">Search Item</label>
            <input type="text" name="search" value="{{ search }}"
                   class="form-control form-control-sm">
        </div>

        <div class="col-md-3">
            <label class="form-label small">Category</label>
            <select name="category" class="form-select form-select-sm">
                <option value="">All Categories</option>
                {% for c in categories %}
                <option value="{{ c.category_name }}"
                        {% if c.category_name == category_filter %}selected{% endif %}>
                    {{ c.category_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small">Location</label>
            <input type="text" name="location" value="{{ location_filter }}"
                   class="form-control form-control-sm">
        </div>

        <div class="col-md-2">
            <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox"
                       name="low_stock" value="1"
                       {% if low_stock %}checked{% endif %}>
                <label class="form-check-label small">Low Stock</label>
            </div>
        </div>

        <div class="col-md-2 d-flex gap-2">
            <button class="btn btn-primary btn-sm w-100">Filter</button>
            <a href="{% url 'inv_app:inventory_master' %}"
               class="btn btn-outline-secondary btn-sm w-100">Reset</a>
        </div>
    </form>

    <!-- ================= PAGINATION TOP BAR ================= -->
    <form method="get" class="d-flex justify-content-between align-items-center mb-2">

        <div class="small text-muted">
            Showing {{ items|length }} of {{ total_count }} items
        </div>

        <!-- preserve filters -->
        <input type="hidden" name="search" value="{{ search }}">
        <input type="hidden" name="category" value="{{ category_filter }}">
        <input type="hidden" name="location" value="{{ location_filter }}">
        {% if low_stock %}
        <input type="hidden" name="low_stock" value="1">
        {% endif %}
        <input type="hidden" name="page" value="1">

        <div class="d-flex align-items-center gap-2">
            <label class="small mb-0">Rows:</label>
            <select name="per_page"
                    class="form-select form-select-sm"
                    onchange="this.form.submit()">
                {% for n in page_sizes %}
                <option value="{{ n }}"
                    {% if per_page == n %}selected{% endif %}>
                    {{ n }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- ================= INVENTORY TABLE ================= -->
    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
            <tr>
                <th>Item</th>
                <th>Category</th>
                <th>Location</th>
                <th>Unit</th>
                <th class="text-end">Stock</th>
                <th class="text-end">Rate</th>
                <th class="text-end">Reorder</th>
                <th class="text-center" style="width:120px;">Action</th>
            </tr>
            </thead>
            <tbody>
            {% for i in items %}
            <tr>
                <td>{{ i.item_name }}</td>
                <td>{{ i.category }}</td>
                <td>{{ i.location }}</td>
                <td>{{ i.unit }}</td>
                <td class="text-end">{{ i.current_qty }}</td>
                <td class="text-end">{{ i.rate }}</td>
                <td class="text-end">{{ i.reorder_level }}</td>
                <td class="text-center">
                    <!-- EDIT -->
                    <button class="btn btn-link p-0 text-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#inventoryModal"
                            onclick="editInventory(
                                '{{ i.id }}',
                                '{{ i.item_name }}',
                                '{{ i.category }}',
                                '{{ i.location }}',
                                '{{ i.unit }}',
                                '{{ i.opening_qty }}',
                                '{{ i.rate }}',
                                '{{ i.reorder_level }}'
                            )">
                        <i class="bi bi-pencil-square"></i>
                    </button>

                    <!-- DELETE -->
                    <form method="POST"
                          action="{% url 'inv_app:inventory_master_delete' i.id %}"
                          class="d-inline"
                          onsubmit="return confirm('Delete this item?');">
                        {% csrf_token %}
                        <button class="btn btn-link p-0 text-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">
                    No inventory items found
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ================= Footer PAGINATION CONTROLS ================= -->
    {% if total_pages > 1 %}
    <nav class="mt-2">
        <ul class="pagination pagination-sm justify-content-end">

            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page|add:'-1' }}&per_page={{ per_page }}">
                    Prev
                </a>
            </li>
            {% endif %}

            {% for p in page_range %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link"
                   href="?page={{ p }}&per_page={{ per_page }}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}

            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page|add:'1' }}&per_page={{ per_page }}">
                    Next
                </a>
            </li>
            {% endif %}

        </ul>
    </nav>
    {% endif %}
</div>

<!-- ================= BULK UPLOAD MODAL ================= -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <form method="POST"
                  action="{% url 'inv_app:inventory_bulk_upload' %}"
                  enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h6 class="modal-title">Inventory Bulk Upload</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="file" name="excel_file"
                           class="form-control form-control-sm" required>
                    <div class="text-danger small mt-2">
                        Category must match Category Master
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary btn-sm w-100">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= ADD / EDIT MODAL ================= -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <form method="POST" action="{% url 'inv_app:inventory_master' %}">
                {% csrf_token %}
                <input type="hidden" name="item_id" id="item_id">

                <div class="modal-header">
                    <h6 class="modal-title">Inventory Item</h6>
                    <button type="button" class="btn-close"
                            data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body row g-2">

                    <!-- ITEM NAME -->
                    <div class="col-md-6">
                        <label class="form-label small">Item Name</label>
                        <input type="text"
                               name="item_name"
                               id="item_name"
                               class="form-control form-control-sm"
                               required>
                    </div>

                    <!-- CATEGORY -->
                    <div class="col-md-6">
                        <label class="form-label small">Category</label>
                        <select name="category"
                                id="category"
                                class="form-select form-select-sm"
                                required>
                            <option value="">Select Category</option>
                            {% for c in categories %}
                            <option value="{{ c.category_name }}">
                                {{ c.category_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- LOCATION -->
                    <div class="col-md-4">
                        <label class="form-label small">Location</label>
                        <input type="text"
                               name="location"
                               id="location"
                               class="form-control form-control-sm">
                    </div>

                    <!-- UNIT -->
                    <div class="col-md-4">
                        <label class="form-label small">Unit</label>
                        <input type="text"
                               name="unit"
                               id="unit"
                               class="form-control form-control-sm"
                               placeholder="Pcs / Sqft / Kg">
                    </div>

                    <!-- OPENING STOCK -->
                    <div class="col-md-4">
                        <label class="form-label small">Opening Stock</label>
                        <input type="number"
                               step="any"
                               name="opening_qty"
                               id="opening_qty"
                               class="form-control form-control-sm">
                    </div>

                    <!-- RATE -->
                    <div class="col-md-6">
                        <label class="form-label small">Rate</label>
                        <input type="number"
                               step="any"
                               name="rate"
                               id="rate"
                               class="form-control form-control-sm">
                    </div>

                    <!-- REORDER LEVEL -->
                    <div class="col-md-6">
                        <label class="form-label small">Reorder Level</label>
                        <input type="number"
                               step="any"
                               name="reorder_level"
                               id="reorder_level"
                               class="form-control form-control-sm">
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary btn-sm"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn btn-success btn-sm">
                        Save
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

<script>
function clearInventoryForm() {
    document.getElementById("item_id").value = "";
    document.getElementById("item_name").value = "";
    document.getElementById("category").value = "";
    document.getElementById("location").value = "";
    document.getElementById("unit").value = "";
    document.getElementById("opening_qty").value = "";
    document.getElementById("rate").value = "";
    document.getElementById("reorder_level").value = "";
}

function editInventory(id, name, category, location, unit, opening, rate, reorder) {
    document.getElementById("item_id").value = id;
    document.getElementById("item_name").value = name;
    document.getElementById("category").value = category;
    document.getElementById("location").value = location || "";
    document.getElementById("unit").value = unit || "";
    document.getElementById("opening_qty").value = opening || 0;
    document.getElementById("rate").value = rate || 0;
    document.getElementById("reorder_level").value = reorder || 0;
}
</script>


{% endblock %}
